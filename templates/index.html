<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document & Web QA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Theme Toggle Button -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/>
    </svg>
    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;">
      <path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/>
    </svg>
  </button>

  <!-- Sidebar Toggle Button -->
  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/>
    </svg>
  </button>

  <!-- Chat History Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Chat History</h2>
      <button class="new-chat-btn" id="new-chat-btn">+ New Chat</button>
    </div>
    <div class="sidebar-content" id="conversations-list">
      <div class="loading-conversations">Loading...</div>
    </div>
  </div>

  <div class="main-content" id="main-content">
    <h1>Ask Questions About Your Files & Websites</h1>
    <div class="nav-links">
      <a href="{{ url_for('stored') }}">View stored articles</a>
      <a href="{{ url_for('batch') }}">Batch ingest (up to 10 URLs)</a>
    </div>

    <form method="POST" enctype="multipart/form-data" class="input-form" id="qa-form">
      <label for="question">Question:</label>
      <textarea id="question" name="question" rows="3" required></textarea>

      <label for="files">Upload files (.pdf, .txt, .doc, .docx, .png, .jpg, .jpeg):</label>
      <input type="file" id="files" name="files" multiple>

      <label for="urls">Website URLs (one per line):</label>
      <textarea id="urls" name="urls" rows="3"
        placeholder="https://example.com/page1&#10;https://example.com/page2"></textarea>

      {% if stored_articles %}
        <fieldset class="stored-select">
          <legend>Select stored articles to include (max 10)</legend>
          <div class="stored-grid">
            {% for a in stored_articles %}
              <label class="stored-item">
                <input type="checkbox" name="stored_ids" value="{{ a.id }}"
                  {% if selected_ids and (a.id|string) in selected_ids %}checked{% endif %}>
                <span class="stored-title">{{ a.url or a.source }}</span>
                <span class="stored-meta">ID {{ a.id }} • {{ a.fetched_at }}</span>
              </label>
            {% endfor %}
          </div>
        </fieldset>
      {% endif %}

      <button type="submit" id="ask-btn">Ask</button>
      <div class="loading" id="loading" aria-live="polite" aria-atomic="true">
        <div class="spinner" aria-hidden="true"></div>
        <span>Thinking...</span>
      </div>
    </form>

    <form method="POST" class="clear-form">
      <input type="hidden" name="clear" value="1">
      <button type="submit" class="secondary">Clear chat & context</button>
    </form>

    {% if answer %}
      <div class="answer-block">
        <h2>Answer</h2>
        <p>{{ answer | safe }}</p>
      </div>

      {% if used_chunks %}
        <div class="sources-block">
          <h3>Sources used</h3>
          <ul>
            {% for ch in used_chunks %}
              <li>
                <strong>{{ ch.source }}</strong><br>
                <span class="snippet">{{ ch.text[:300] }}{% if ch.text|length > 300 %}...{% endif %}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endif %}

    {% if history %}
      <div class="history-block">
        <h2>Conversation History</h2>
        {% for msg in history %}
          <div class="message {{ msg.role }}">
            <strong>{{ 'You' if msg.role == 'user' else 'Assistant' }}:</strong>
            <p>{{ msg.content }}</p>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("qa-form");
      const button = document.getElementById("ask-btn");
      const loading = document.getElementById("loading");
      if (!form) return;
      form.addEventListener("submit", () => {
        if (loading) loading.classList.add("visible");
        if (button) {
          button.disabled = true;
          button.setAttribute("aria-busy", "true");
        }
      });

      // Theme toggle functionality
      const themeToggle = document.getElementById("theme-toggle");
      const sunIcon = document.getElementById("sun-icon");
      const moonIcon = document.getElementById("moon-icon");
      const body = document.body;

      // Load saved theme preference
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "light") {
        body.classList.add("light-mode");
        sunIcon.style.display = "none";
        moonIcon.style.display = "block";
      }

      // Toggle theme on button click
      themeToggle.addEventListener("click", () => {
        body.classList.toggle("light-mode");
        const isLight = body.classList.contains("light-mode");
        
        // Toggle icons
        if (isLight) {
          sunIcon.style.display = "none";
          moonIcon.style.display = "block";
          localStorage.setItem("theme", "light");
        } else {
          sunIcon.style.display = "block";
          moonIcon.style.display = "none";
          localStorage.setItem("theme", "dark");
        }
      });

      // Sidebar functionality
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebar-toggle");
      const mainContent = document.getElementById("main-content");
      const newChatBtn = document.getElementById("new-chat-btn");
      const conversationsList = document.getElementById("conversations-list");

      // Load sidebar state
      const sidebarOpen = localStorage.getItem("sidebarOpen") !== "false";
      if (sidebarOpen) {
        sidebar.classList.add("open");
        mainContent.classList.add("sidebar-open");
      }

      // Toggle sidebar
      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("open");
        mainContent.classList.toggle("sidebar-open");
        localStorage.setItem("sidebarOpen", sidebar.classList.contains("open"));
      });

      // New chat button
      newChatBtn.addEventListener("click", () => {
        window.location.href = "/";
      });

      // Load conversations
      async function loadConversations() {
        try {
          const response = await fetch("/conversations");
          const conversations = await response.json();
          
          if (conversations.length === 0) {
            conversationsList.innerHTML = '<div class="no-conversations">No conversations yet</div>';
            return;
          }

          conversationsList.innerHTML = conversations.map(conv => `
            <div class="conversation-item" data-id="${conv.id}">
              <div class="conversation-title">${conv.title}</div>
              <div class="conversation-meta">${new Date(conv.updated_at).toLocaleDateString()}</div>
              <button class="delete-conv-btn" data-id="${conv.id}" aria-label="Delete conversation">×</button>
            </div>
          `).join("");

          // Add click handlers
          document.querySelectorAll(".conversation-item").forEach(item => {
            item.addEventListener("click", (e) => {
              if (!e.target.classList.contains("delete-conv-btn")) {
                const convId = item.dataset.id;
                window.location.href = `/conversation/${convId}`;
              }
            });
          });

          // Add delete handlers
          document.querySelectorAll(".delete-conv-btn").forEach(btn => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const convId = btn.dataset.id;
              if (confirm("Delete this conversation?")) {
                await fetch(`/conversation/${convId}/delete`, { method: "POST" });
                loadConversations();
              }
            });
          });
        } catch (error) {
          conversationsList.innerHTML = '<div class="error">Error loading conversations</div>';
        }
      }

      loadConversations();
    });
  </script>
</body>
</html>
